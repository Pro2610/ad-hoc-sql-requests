WITH daily_kpis AS (
  SELECT
    DATE(payment_date) AS day,
    SUM(revenue_amount) AS revenue,
    COUNT(DISTINCT user_id) AS paid_users,
    COUNT(*) AS transactions,
    SAFE_DIVIDE(SUM(revenue_amount), COUNT(DISTINCT user_id)) AS arppu
  FROM `project.dataset.payments`
  WHERE DATE(payment_date) >= DATE_SUB(CURRENT_DATE(), INTERVAL 30 DAY)
  GROUP BY 1
)
SELECT
  day,
  revenue,
  paid_users,
  transactions,
  arppu,

  AVG(revenue) OVER (ORDER BY day ROWS BETWEEN 7 PRECEDING AND 1 PRECEDING) AS revenue_baseline,
  AVG(paid_users) OVER (ORDER BY day ROWS BETWEEN 7 PRECEDING AND 1 PRECEDING) AS paid_users_baseline,
  AVG(arppu) OVER (ORDER BY day ROWS BETWEEN 7 PRECEDING AND 1 PRECEDING) AS arppu_baseline
FROM daily_kpis;
