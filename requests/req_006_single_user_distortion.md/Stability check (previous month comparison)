SELECT
  DATE_TRUNC(DATE(payment_date), MONTH) AS month,
  COUNT(DISTINCT user_id) AS paid_users,
  SUM(revenue_amount) AS revenue,
  SAFE_DIVIDE(
    SUM(revenue_amount),
    COUNT(DISTINCT user_id)
  ) AS arppu
FROM `project.dataset.payments`
WHERE DATE_TRUNC(DATE(payment_date), MONTH)
      BETWEEN DATE_SUB(DATE_TRUNC(CURRENT_DATE(), MONTH), INTERVAL 1 MONTH)
          AND DATE_TRUNC(CURRENT_DATE(), MONTH)
GROUP BY 1
ORDER BY month;
