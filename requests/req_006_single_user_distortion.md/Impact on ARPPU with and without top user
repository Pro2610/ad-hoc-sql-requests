WITH user_revenue AS (
  SELECT
    user_id,
    SUM(revenue_amount) AS revenue
  FROM `project.dataset.payments`
  WHERE DATE_TRUNC(DATE(payment_date), MONTH) = DATE_TRUNC(CURRENT_DATE(), MONTH)
  GROUP BY 1
),
metrics AS (
  SELECT
    SAFE_DIVIDE(SUM(revenue), COUNT(DISTINCT user_id)) AS arppu_with_all
  FROM user_revenue
),
metrics_without_top AS (
  SELECT
    SAFE_DIVIDE(SUM(revenue), COUNT(DISTINCT user_id)) AS arppu_without_top
  FROM user_revenue
  WHERE user_id NOT IN (
    SELECT user_id
    FROM user_revenue
    ORDER BY revenue DESC
    LIMIT 1
  )
)
SELECT
  m.arppu_with_all,
  mw.arppu_without_top,
  m.arppu_with_all - mw.arppu_without_top AS arppu_distortion
FROM metrics m, metrics_without_top mw;
