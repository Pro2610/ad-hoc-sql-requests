WITH user_revenue AS (
  SELECT
    user_id,
    SUM(revenue_amount) AS revenue
  FROM `project.dataset.payments`
  WHERE DATE_TRUNC(DATE(payment_date), MONTH) = DATE_TRUNC(CURRENT_DATE(), MONTH)
  GROUP BY 1
),
totals AS (
  SELECT
    SUM(revenue) AS total_revenue
  FROM user_revenue
),
top_user AS (
  SELECT
    user_id,
    revenue
  FROM user_revenue
  ORDER BY revenue DESC
  LIMIT 1
)
SELECT
  t.user_id AS top_user_id,
  t.revenue AS top_user_revenue,
  tot.total_revenue,
  SAFE_DIVIDE(t.revenue, tot.total_revenue) AS top_user_revenue_share
FROM top_user t
CROSS JOIN totals tot;
