WITH user_base AS (
  SELECT
    user_id,
    MAX(DATE(payment_date)) AS last_payment_date,
    COUNT(*) AS total_transactions,
    SUM(revenue_amount) AS total_revenue,
    SAFE_DIVIDE(SUM(revenue_amount), COUNT(*)) AS avg_transaction_value
  FROM `project.dataset.payments`
  GROUP BY 1
)
