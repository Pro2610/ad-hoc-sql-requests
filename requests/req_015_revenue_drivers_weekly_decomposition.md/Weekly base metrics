WITH weekly_metrics AS (
  SELECT
    DATE_TRUNC(DATE(payment_date), WEEK(MONDAY)) AS week,
    SUM(revenue_amount) AS revenue,
    COUNT(DISTINCT user_id) AS paid_users,
    SAFE_DIVIDE(
      SUM(revenue_amount),
      COUNT(DISTINCT user_id)
    ) AS arppu
  FROM `project.dataset.payments`
  WHERE DATE(payment_date) >= DATE_SUB(CURRENT_DATE(), INTERVAL 12 WEEK)
  GROUP BY 1
)
