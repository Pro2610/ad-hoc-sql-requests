, segment_metrics AS (
  SELECT
    period,
    location,
    software_name,
    user_type,
    SUM(revenue_amount) AS revenue,
    COUNT(DISTINCT user_id) AS paid_users,
    SAFE_DIVIDE(SUM(revenue_amount), COUNT(DISTINCT user_id)) AS arppu
  FROM base
  GROUP BY 1,2,3,4
)
