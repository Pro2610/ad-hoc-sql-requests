WITH ranked AS (
  SELECT
    c.user_id,
    c.last_month_revenue,
    ROW_NUMBER() OVER (ORDER BY c.last_month_revenue DESC) AS rnk,
    COUNT(*) OVER () AS total_churned
  FROM churned_last_month c
)
SELECT
  r.user_id,
  r.last_month_revenue
FROM ranked r
WHERE r.rnk <= r.total_churned * 0.10
ORDER BY r.last_month_revenue DESC;
