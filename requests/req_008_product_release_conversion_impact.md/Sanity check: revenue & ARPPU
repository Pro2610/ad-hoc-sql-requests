SELECT
  CASE
    WHEN DATE(payment_date) < release_date THEN 'pre_release'
    ELSE 'post_release'
  END AS period,
  COUNT(DISTINCT user_id) AS paid_users,
  SUM(revenue_amount) AS revenue,
  SAFE_DIVIDE(
    SUM(revenue_amount),
    COUNT(DISTINCT user_id)
  ) AS arppu
FROM `project.dataset.payments`
WHERE DATE(payment_date)
      BETWEEN DATE_SUB(release_date, INTERVAL 7 DAY)
          AND DATE_ADD(release_date, INTERVAL 7 DAY)
GROUP BY 1;
