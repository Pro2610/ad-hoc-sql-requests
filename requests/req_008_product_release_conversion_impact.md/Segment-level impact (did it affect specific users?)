WITH base AS (
  SELECT
    CASE
      WHEN DATE(payment_date) < release_date THEN 'pre_release'
      ELSE 'post_release'
    END AS period,
    location,
    software_name,
    `User Type` AS user_type,
    COUNT(DISTINCT user_id) AS converted_users
  FROM `project.dataset.payments`
  WHERE DATE(payment_date)
        BETWEEN DATE_SUB(release_date, INTERVAL 7 DAY)
            AND DATE_ADD(release_date, INTERVAL 7 DAY)
  GROUP BY 1,2,3,4
),
pivoted AS (
  SELECT
    location,
    software_name,
    user_type,
    SUM(IF(period='pre_release', converted_users, 0)) AS pre_users,
    SUM(IF(period='post_release', converted_users, 0)) AS post_users
  FROM base
  GROUP BY 1,2,3
)
SELECT
  location,
  software_name,
  user_type,
  pre_users,
  post_users,
  SAFE_DIVIDE(post_users - pre_users, NULLIF(pre_users, 0)) AS conversion_delta_pct
FROM pivoted
ORDER BY conversion_delta_pct ASC
LIMIT 20;
