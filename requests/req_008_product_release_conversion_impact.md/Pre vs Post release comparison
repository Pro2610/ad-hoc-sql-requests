WITH daily AS (
  SELECT
    DATE(payment_date) AS day,
    COUNT(DISTINCT user_id) AS converted_users
  FROM `project.dataset.payments`
  WHERE DATE(payment_date)
        BETWEEN DATE_SUB(release_date, INTERVAL 7 DAY)
            AND DATE_ADD(release_date, INTERVAL 7 DAY)
  GROUP BY 1
),
periods AS (
  SELECT
    CASE
      WHEN day < release_date THEN 'pre_release'
      ELSE 'post_release'
    END AS period,
    AVG(converted_users) AS avg_converted_users
  FROM daily
  GROUP BY 1
)
SELECT * FROM periods;
